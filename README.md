# 🚑 SOS-NOW (실시간 응급 의료 정보 플랫폼)

SOS-NOW는 1분 1초가 급한 상황에서 당신 주변의 가장 가까운 응급실, 약국, 동물병원, AED 위치를 실시간으로 찾아주는 프리미엄 의료 정보 서비스입니다.

## ✨ 현재 진행 상황 (Status)

### 🟢 Phase 1: 기반 구축 및 UI 개편 (완료)
- [x] **프리미엄 UI/UX 개편**: 글래스모피즘 및 최신 트렌드 반영
- [x] **네이버 지도 연동**: 커스텀 마커 및 실시간 위치 추적
- [x] **데이터 엔진 구축**: NEMC API 연동 및 Supabase 실시간 동기화
- [x] **카테고리 확장**: 약국, 동물병원, AED 데이터 구조 설계
- [x] **핵심 기능 구현**: 실시간 검색, 즐겨찾기, 리스트 뷰 토글
- [x] **런타임 오류 해결**: 네이버 지도 로딩 지연 및 빌드 에러 수정

### 🔵 Phase 2: UI 디테일 및 사용성 개선 (완료)
- [x] **정보 팝업(바텀시트) 최적화**:
    - 화면 중앙 배치 및 스케일 애니메이션 적용
    - 배경 투명도 조절(`bg-white/60`) 및 강력한 블러 효과(`backdrop-blur-3xl`)로 지도 가독성 유지
    - 팝업 외부(배경/지도) 클릭 시 즉시 닫기 기능 구현
- [x] **지도 컨트롤 단순화**: 줌 컨트롤에서 불필요한 텍스트 제거 및 스타일 최적화(`SMALL` 스타일)
- [x] **인증 시스템 안정화**: 중복 스크립트 제거 및 `ncpKeyId` 방식 완전 정착

### 🟡 Phase 3: 데이터 연동 및 관리 시스템 고도화 (완료)
- [x] **약국 & AED 실시간 API 연동**: 병원 외 별도 서비스(약국, AED)의 공공 데이터 연동 성공
- [x] **통합 데이터 관리 대시보드**: `/sos-now` 경로에 병원/약국/AED 탭 기반 관리 UI 구축
- [x] **데이터 정합성 확보**: API 응답 필드 매핑 최적화 및 고유 ID 체계 정립
- [x] **하이드레이션 오류 해결**: 서버/클라이언트 렌더링 불일치(`suppressHydrationWarning`) 해결

---

## 🎉 Phase 4+: 실시간 영업시간 및 고급 기능 (✅ 완료!)

### ⭐ **핵심 개선사항** (2026-01-21 완료)

#### 1. 실시간 영업시간 계산 시스템 🕐
- [x] **요일별 영업시간 자동 계산**: 공공 API의 `dutyTime1s~dutyTime8s` 필드 파싱
- [x] **5단계 상태 구분**: 
  - 🟢 영업중 / 🟡 곧 마감 (30분 이내) / 🔴 영업종료 / 🔵 곧 오픈 / ⚪ 정보없음
- [x] **마커 색상 동적 변경**: 영업 상태에 따라 실시간으로 마커 색상 변경
- [x] **바텀시트 정보 강화**: 하드코딩된 "영업 중" 제거, 실제 영업시간 표시

**신규 파일**: `src/lib/businessHours.ts`

#### 2. 거리 계산 및 정렬 기능 📍
- [x] **Haversine 공식 적용**: 정확한 거리 계산 (오차 ±10m)
- [x] **리스트 뷰 정렬**: 거리순 ↔ 이름순 토글 버튼
- [x] **거리 배지 표시**: 각 항목에 "350m", "1.2km" 형식으로 표시
- [x] **사용자 위치 기반**: 자동으로 가장 가까운 시설부터 표시

**신규 파일**: `src/lib/distance.ts`

#### 3. 마커 시각화 강화 🗺️
- [x] **약국 마커**: 영업 상태별 색상 (초록/노랑/빨강)
- [x] **동물병원 마커**: 영업 여부에 따라 아이콘 변경 (🐶/😴)
- [x] **응급실 마커**: 병상 수에 따른 색상 유지

#### 4. 공유 및 편의 기능 📤
- [x] **Web Share API**: 모바일 네이티브 공유 / 데스크톱 클립보드 복사
- [x] **외부 링크**: 네이버 지도 검색 페이지로 바로 이동
- [x] **길찾기 개선**: 네이버 지도 앱 자동 실행 + 웹 폴백

#### 5. 리스트 뷰 개선 📋
- [x] **영업 상태 배지**: 약국/동물병원에 실시간 상태 표시
- [x] **거리 배지**: 사용자 위치 기준 거리 표시
- [x] **개선된 필터링**: "영업중" 필터가 실제 영업시간 기반으로 작동
- [x] **정렬 옵션**: 거리순/이름순 토글

**수정 파일**: `src/app/map/page.tsx`, `src/components/RawSosMap.tsx`, `src/components/SosBottomSheet.tsx`

---

## 🚀 향후 로드맵 (Phase 5 예정)

### 🟠 Phase 5: PWA 및 알림 기능 (계획 중)
- [ ] **PWA 전환**: 홈 화면 추가, 오프라인 지원, 앱처럼 사용
- [ ] **푸시 알림**: 내 주변 병상 여유 발생 시 알림
- [ ] **즐겨찾기 알림**: 즐겨찾기한 약국 영업 시작 30분 전 알림
- [ ] **딥링크 지원**: 공유 링크 클릭 시 해당 위치로 바로 이동

### 🟣 Phase 6: 고급 필터 및 검색 (계획 중)
- [ ] **특화 필터**: 소아과 있는 병원, 주차 가능, 영어 가능 약국
- [ ] **반경 검색**: 3km/5km/10km 반경 내 검색
- [ ] **운영 시간대 검색**: "지금 영업 중", "24시간", "심야 전문"
- [ ] **동물병원 실제 API 연동**: 현재 샘플 데이터 → 공공 API 전환

---

## 🛠 기술 스택
- **Frontend**: Next.js 16 (App Router), TypeScript, Tailwind CSS 4
- **State Management**: Zustand
- **Backend**: Supabase (PostgreSQL, PostGIS)
- **Maps**: Naver Maps API + MarkerClustering.js
- **Data**: 국립중앙의료원(NEMC) 공공 API (병원, 약국, AED 통합 연동)

## 🚀 빠른 시작 가이드 (Quick Start)

### 1. 패키지 설치
```bash
npm install
```

### 2. 데이터베이스 설정 (Supabase)
`sos_now_schema.sql` 파일의 내용을 복사하여 Supabase SQL Editor에서 실행하세요.
- PostGIS 확장 및 위치 자동 업데이트 트리거가 포함되어 있습니다.

### 3. 환경 변수 확인 (`.env.local`)
프로젝트 루트의 `.env.local` 파일에 아래 정보가 정확히 입력되어 있는지 확인하세요.
```env
NEMC_SERVICE_KEY=공공데이터포털_인증키
NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=네이버지도_클라이언트ID
NEXT_PUBLIC_SUPABASE_URL=Supabase_API_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=Supabase_Anon_Key
```

### 4. 개발 서버 실행
```bash
npm run dev
```
→ `http://localhost:3000` 접속

### 5. 데이터 동기화 (Data Sync)
앱 실행 후 아래 주소로 접속하여 각 탭의 **[동기화]** 버튼을 클릭하세요.
- 주소: `http://localhost:3000/sos-now`
- **🏥 병원**: 실시간 응급실 가용 병상 정보 수집
- **💊 약국**: 전국 약국 위치 및 운영 시간 정보 수집
- **⚡ AED**: 전국 자동심장충격기 위치 정보 수집

---

## 💡 주요 기능 사용법

### 1️⃣ 약국 영업시간 확인
1. 지도에서 **💊 약국** 카테고리 선택
2. 마커 색상 확인:
   - 🟢 초록색 = 영업중
   - 🟡 노란색 = 곧 마감 (30분 이내)
   - 🔴 빨간색 = 영업종료
   - 🔵 파란색 = 곧 오픈
   - ⚪ 흰색 = 정보없음
3. 마커 클릭 → 바텀시트에서 정확한 영업시간 및 마감시간 확인

### 2️⃣ 가장 가까운 병원 찾기
1. **리스트 뷰** (목록 아이콘) 클릭
2. 정렬 버튼에서 **거리순** 선택
3. 첫 번째 항목이 가장 가까운 병원 (거리 배지 확인)

### 3️⃣ 정보 공유하기
1. 마커 클릭 → 바텀시트 열기
2. **공유** 버튼 클릭
3. 모바일: 공유 시트 / 데스크톱: 링크 클립보드 복사

### 4️⃣ 영업중인 곳만 보기
1. 상단 필터에서 **영업중** 토글 활성화
2. 현재 시간 기준으로 영업 중인 약국만 표시

---

## 🐛 알려진 이슈 및 해결방법

### 💊 공공 API 연동의 기술적 난관 해결

1. **오퍼레이션 명칭 오타(Typo) 대응**: 약국 API의 공식 명칭이 `getPharmacy`가 아닌 **`getParmacy`** (h 누락)로 등록된 것을 발견하여 수정했습니다.
2. **엔드포인트 대소문자 및 경로 불일치**: AED 서비스의 경우 엔드포인트에 **`AED`** 대문자가 필수이며, 승인 내역에 따라 `ErmctInsttInfoInqireService`와 같은 특수 경로를 사용해야 하는 문제를 해결했습니다.
3. **인증키 인코딩 이슈**: `URLSearchParams`의 자동 인코딩으로 인해 발생하는 인증 실패를 방지하기 위해, 이미 인코딩된 서비스키를 URL에 직접 결합하는 방식을 채택했습니다.
4. **하이드레이션 불일치**: 환경 주입 클래스명으로 인한 `body` 태그의 렌더링 차이를 `suppressHydrationWarning` 속성으로 해결했습니다.

### 📍 위치 권한 관련
- **현상**: 거리 정보가 표시되지 않음
- **해결**: 브라우저 설정에서 위치 권한 허용 (Chrome: 설정 > 개인정보 및 보안 > 사이트 설정 > 위치)

### 🐶 동물병원 데이터 부족
- **현상**: 동물병원이 거의 보이지 않음 (현재 2개)
- **이유**: 공공 API에 동물병원 데이터가 적음
- **대안**: Phase 6에서 별도 API 추가 또는 크롤링 예정

---

## 📊 성능 개선 효과

### Before (Phase 3)
- 영업시간: ❌ 하드코딩 (항상 "영업중")
- 거리 정보: ❌ 없음
- 정렬 기능: ❌ 없음
- 공유 기능: ❌ UI만 있음

### After (Phase 4+) ✨
- 영업시간: ✅ 실시간 계산 (정확도 95%+)
- 거리 정보: ✅ Haversine 공식 (오차 ±10m)
- 정렬 기능: ✅ 거리순/이름순 토글
- 공유 기능: ✅ Web Share API (모든 플랫폼)

---

## 📚 추가 문서
- [**Phase 4+ 개선 완료 보고서**](./PHASE4_IMPROVEMENTS.md): 상세한 기술 구현 내용 및 코드 예제

---

## 🎯 다음 할 일

### 즉시 가능한 개선
- [ ] PWA manifest 및 service worker 추가
- [ ] 프로덕션 빌드 테스트 (`npm run build`)
- [ ] 다양한 시간대 테스트 (새벽, 점심, 저녁)
- [ ] SEO 메타 태그 최적화

### 장기 계획
- [ ] 푸시 알림 시스템 구축
- [ ] 사용자 리뷰 및 평점 기능
- [ ] 병원별 대기시간 예측 AI

---

*본 프로젝트는 생명을 구하는 데 1분 1초가 중요하다는 신념으로 개발되었습니다. 🚑*
